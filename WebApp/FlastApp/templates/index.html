<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Light Sensor Graph</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Light Sensor Data</h1>
    <p>Current Lux Value: <span id="lux-value">Waiting...</span></p>
    
    <!-- Graph Container -->
    <canvas id="lightChart"></canvas>

    <script>
        var socket = io.connect('http://' + document.domain + ':' + location.port);

        // Chart.js Setup
        var ctx = document.getElementById('lightChart').getContext('2d');
        var lightChart = new Chart(ctx, {
            type: 'line', // Line graph
            data: {
                labels: [], // Time labels
                datasets: [{
                    label: 'Light Sensor (Lux)',
                    data: [],  // Sensor values
                    borderColor: 'blue',
                    backgroundColor: 'rgba(0, 0, 255, 0.1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: 'Time' } },
                    y: { title: { display: true, text: 'Lux Value' }, beginAtZero: true }
                }
            }
        });

        socket.on('connect', function() {
            console.log("Connected to WebSocket");
        });

        socket.on('light_update', function(data) {
            console.log("Received:", data);

            let now = new Date().toLocaleTimeString();
            let luxValue = data.light;

            // Update the displayed value
            if (isNaN(parseFloat(luxValue))) {
                luxValue = 0;  // If luxValue is not a float (like "heartbeat"), set to 0
                document.getElementById("lux-value").innerText = "No valid data (0)";
    lightChart.update();
          
            } else {
            document.getElementById("lux-value").innerText = luxValue;

            // Update the chart only if the value is a number
            if (!isNaN(luxValue)) {
                lightChart.data.labels.push(now);
                lightChart.data.datasets[0].data.push(parseFloat(luxValue));

            // Keep only the last 20 readings
            if (lightChart.data.labels.length > 60) {
                lightChart.data.labels.shift();
                lightChart.data.datasets[0].data.shift();
            }
            lightChart.update();

        }
    }

        });

        socket.on('disconnect', function() {
            console.log("Disconnected from WebSocket");
        });
    </script>
</body>
</html>
